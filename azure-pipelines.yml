trigger:
- main

pool:
  name: Default

variables:
  acrurl: 'lavender.azurecr.io'
  kubernetesServiceConnection: 'K8S_SERVICE_CONNECTION'
  namespace: 'default'
  releaseName: 'sampleapi-release'

steps:
# Étapes CI
- task: Docker@0
  displayName: 'Build an image'
  inputs:
    azureSubscription: $(kubernetesServiceConnection)
    azureContainerRegistry: '{"loginServer":"lavender.azurecr.io", "id": "/subscriptions/..."}'
    imageName: '$(acrurl)/sampleapi:$(Build.BuildId)'

- task: Docker@0
  displayName: 'Push an image'
  inputs:
    azureSubscription: $(kubernetesServiceConnection)
    azureContainerRegistry: '{"loginServer":"lavender.azurecr.io", "id": "/subscriptions/..."}'
    imageName: '$(acrurl)/sampleapi:$(Build.BuildId)'

- task: HelmInstaller@0
  displayName: 'Install Helm 2.14.1'

- task: HelmDeploy@1
  displayName: 'helm package'
  inputs:
    azureSubscriptionForACR: $(kubernetesServiceConnection)
    azureResourceGroupForACR: 'K8S_RG'
    azureContainerRegistry: lavender.azurecr.io
    command: package
    chartPath: helm
    chartVersion: '$(Build.BuildId)'
    chartNameForACR: Chart
    chartPathForACR: helm/Chart.yaml

- task: PublishPipelineArtifact@1
  displayName: 'Publish Helm Chart as Artifact'
  inputs:
    targetPath: 'helm/*.tgz'
    artifact: helm-chart

# Étapes CD
- task: DownloadPipelineArtifact@2
  displayName: 'Download Helm Chart Artifact'
  inputs:
    artifact: 'helm-chart'
    path: '$(System.ArtifactsDirectory)/helm'

- script: |
    echo "Vérification des fichiers téléchargés :"
    ls -la $(System.ArtifactsDirectory)/helm
  displayName: 'Verify Helm Chart Files'

- task: HelmDeploy@0
  displayName: 'Deploy to Kubernetes'
  inputs:
    azureSubscription: $(kubernetesServiceConnection)
    azureResourceGroup: 'K8S_RG'
    kubernetesCluster: 'MyAKSCluster'
    namespace: $(namespace)
    command: upgrade
    chartType: FilePath
    chartPath: '$(System.ArtifactsDirectory)/helm/nodesampleapi-*.tgz'
    releaseName: $(releaseName)
    overrideValues: |
      image.repository=$(acrurl)/sampleapi
      image.tag=$(Build.BuildId)
    install: true
  continueOnError: false
